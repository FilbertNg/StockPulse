name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  REGISTRY: "registry.digitalocean.com/finpro"
  IMAGE_NAME: "sentiment-analysis"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Check out the code
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: Set up Docker Buildx
    - name: Set up Docker
      uses: docker/setup-buildx-action@v2

    # Step 3: Build and Tag Docker Image
    - name: Build and Tag Docker Image
      run: |
        echo "Building Docker image..."
        docker build -t $REGISTRY/$IMAGE_NAME:${GITHUB_SHA::7} .
        docker tag $REGISTRY/$IMAGE_NAME:${GITHUB_SHA::7} $REGISTRY/$IMAGE_NAME:latest

    # Step 4: Install doctl (DigitalOcean CLI)
    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

    # Step 5: Log in to DigitalOcean Container Registry
    - name: Log in to DigitalOcean Container Registry
      run: doctl registry login --expiry-seconds 600

    # Step 6: Push Image to DigitalOcean Container Registry
    - name: Push Docker Image
      run: |
        echo "Pushing Docker image to registry..."
        docker push $REGISTRY/$IMAGE_NAME:${GITHUB_SHA::7}
        docker push $REGISTRY/$IMAGE_NAME:latest

    # Step 7: Deploy to DigitalOcean Droplet
    - name: Deploy to DigitalOcean Droplet
      env:
        SSH_HOST: ${{ secrets.DIGITALOCEAN_HOST }}
        SSH_USERNAME: ${{ secrets.DIGITALOCEAN_USERNAME }}
        SSH_PRIVATE_KEY: ${{ secrets.DIGITALOCEAN_PRIVATE_KEY }}
      run: |
        echo "Setting up SSH access..."
        echo "$SSH_PRIVATE_KEY" > private_key.pem
        chmod 600 private_key.pem
        
        echo "Transferring files to remote server..."
        scp -i private_key.pem docker-compose.yaml $SSH_USERNAME@$SSH_HOST:~/sentiment-analysis/
        rsync -avz -e "ssh -i private_key.pem" . $SSH_USERNAME@$SSH_HOST:~/sentiment-analysis/
        
        echo "Deploying application on the server..."
        ssh -i private_key.pem $SSH_USERNAME@$SSH_HOST "
          cd ~/sentiment-analysis &&
          docker-compose down &&
          docker-compose up -d
        "
